{% extends "layout/basic.html" %}
{% block title %}{{ problem.title }} - 查重详情{% endblock %}

{% block content %}
<style>
/* 题目查重详情页面样式 */
.problem-detail-container {
  max-width: 1600px;
  margin: 20px auto;
  padding: 0 20px;
}

.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 40px 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 30px,
    rgba(255,255,255,0.1) 30px,
    rgba(255,255,255,0.1) 60px
  );
  animation: headerAnimation 12s linear infinite;
}

@keyframes headerAnimation {
  0% { transform: translateX(-100px) translateY(-100px) rotate(0deg); }
  100% { transform: translateX(100px) translateY(100px) rotate(360deg); }
}

.header-content {
  position: relative;
  z-index: 1;
}

.problem-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 16px;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1rem;
  opacity: 0.9;
  margin-bottom: 16px;
}

.breadcrumb a {
  color: white;
  text-decoration: none;
  opacity: 0.8;
}

.breadcrumb a:hover {
  opacity: 1;
  text-decoration: underline;
}

.problem-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  font-size: 1rem;
  opacity: 0.9;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* 语言标签页 */
.language-tabs {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
}

.tabs-header {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tabs-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.tabs-nav {
  display: flex;
  background: #f8fafc;
  border-bottom: 2px solid #e5e7eb;
}

.tab-button {
  padding: 16px 24px;
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab-button:hover {
  color: #4facfe;
  background: #f1f5f9;
}

.tab-button.active {
  color: #4facfe;
  border-bottom-color: #4facfe;
  background: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* 语言统计卡片 */
.language-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  padding: 24px;
  background: #f8fafc;
}

.lang-stat-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.lang-stat-icon {
  font-size: 2rem;
  margin-bottom: 8px;
  display: block;
}

.lang-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 4px 0;
}

.lang-stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

/* 相似度对列表 */
.similarity-pairs {
  padding: 24px;
}

.pairs-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 20px;
}

.pairs-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.pairs-filter {
  display: flex;
  gap: 12px;
  align-items: center;
}

.filter-select {
  padding: 8px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  background: white;
  font-size: 0.875rem;
}

.filter-select:focus {
  outline: none;
  border-color: #4facfe;
}

/* 相似度对卡片 */
.similarity-pair {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 16px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.similarity-pair:hover {
  border-color: #4facfe;
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
}

.pair-header {
  background: #f8fafc;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.pair-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.pair-users {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  color: #1f2937;
}

.user-badge {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
}

.vs-divider {
  color: #6b7280;
  font-weight: 400;
}

.pair-similarity {
  display: flex;
  align-items: center;
  gap: 12px;
}

.similarity-value {
  font-size: 1.25rem;
  font-weight: 700;
  padding: 8px 16px;
  border-radius: 20px;
}

.similarity-value--low {
  background: #d1fae5;
  color: #059669;
}

.similarity-value--medium {
  background: #fef3c7;
  color: #d97706;
}

.similarity-value--high {
  background: #fee2e2;
  color: #dc2626;
}

.pair-expand {
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  font-size: 1.2rem;
  transition: transform 0.3s ease;
}

.pair-expand.expanded {
  transform: rotate(180deg);
}

.pair-details {
  padding: 20px;
  border-top: 1px solid #e5e7eb;
  display: none;
}

.pair-details.expanded {
  display: block;
}

/* 代码匹配展示 */
.code-matches {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.code-panel {
  background: #1f2937;
  border-radius: 8px;
  overflow: hidden;
}

.code-header {
  background: #374151;
  color: white;
  padding: 12px 16px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.code-user {
  display: flex;
  align-items: center;
  gap: 8px;
}

.code-stats {
  font-size: 0.875rem;
  opacity: 0.8;
}

.code-content {
  padding: 16px;
  color: #f3f4f6;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.875rem;
  line-height: 1.5;
  max-height: 400px;
  overflow-y: auto;
}

.code-line {
  position: relative;
  padding: 2px 0;
}

.code-line-number {
  display: inline-block;
  width: 40px;
  color: #6b7280;
  text-align: right;
  margin-right: 16px;
  user-select: none;
}

.code-highlight {
  background: rgba(239, 68, 68, 0.3);
  padding: 0 4px;
  border-radius: 3px;
  animation: highlightPulse 2s infinite;
}

@keyframes highlightPulse {
  0%, 100% { background: rgba(239, 68, 68, 0.3); }
  50% { background: rgba(239, 68, 68, 0.5); }
}

/* 匹配统计 */
.match-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.match-stat {
  background: #f8fafc;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.match-stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 4px 0;
}

.match-stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

/* 空状态 */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .problem-detail-container {
    padding: 0 16px;
  }
  
  .page-header {
    padding: 30px 20px;
  }
  
  .problem-title {
    font-size: 2rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .tabs-nav {
    flex-wrap: wrap;
  }
  
  .tab-button {
    flex: 1;
    min-width: 120px;
  }
  
  .language-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .code-matches {
    grid-template-columns: 1fr;
  }
  
  .pair-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
}

/* section重置 */
.section {
  background: transparent;
  box-shadow: none;
}

.section__header {
  display: none;
}

.section__body {
  padding: 0;
}
</style>

<div class="section">
  <div class="section__body">
    <div class="problem-detail-container">
      <!-- 页面头部 -->
      <div class="page-header">
        <div class="header-content">
          <div class="breadcrumb">
            <a href="/plagiarism">查重系统</a>
            <span>›</span>
            <a href="/plagiarism/contest">比赛查重</a>
            <span>›</span>
            <a href="/plagiarism/contest/{{ contest.id }}">{{ contest.title }}</a>
            <span>›</span>
            <span>{{ problem.title }}</span>
          </div>
          <h1 class="problem-title">
            <span>📄</span> {{ problem.title }}
          </h1>
          <div class="problem-meta">
            <div class="meta-item">
              <span>🆔</span>
              <span>题目 ID: {{ problem.id }}</span>
            </div>
            <div class="meta-item">
              <span>📊</span>
              <span>{{ problem.total_submissions }} 总提交</span>
            </div>
            <div class="meta-item">
              <span>✅</span>
              <span>{{ problem.accepted_submissions }} 通过</span>
            </div>
            <div class="meta-item">
              <span>🕒</span>
              <span>{{ problem.last_check_at.strftime('%Y-%m-%d %H:%M') if problem.last_check_at else '未检查' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 语言标签页 -->
      <div class="language-tabs">
        <div class="tabs-header">
          <h2 class="tabs-title">
            <span>🌐</span> 分语言查重结果
          </h2>
        </div>

        <!-- 标签导航 -->
        <div class="tabs-nav">
          {% for lang_result in language_results %}
          <button class="tab-button {% if loop.first %}active{% endif %}" 
                  onclick="switchTab('{{ lang_result.language }}')">
            <span>{{ lang_result.language_icon }}</span>
            {{ lang_result.language_display }}
            <span style="background: rgba(79, 172, 254, 0.2); color: #0369a1; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
              {{ lang_result.submission_count }}
            </span>
          </button>
          {% endfor %}
          {% if not language_results %}
          <div style="padding: 20px; text-align: center; color: #6b7280;">
            <span>❌</span> 该题目暂无可分析的语言提交
          </div>
          {% endif %}
        </div>

        <!-- 标签内容 -->
        {% for lang_result in language_results %}
        <div class="tab-content {% if loop.first %}active{% endif %}" id="tab-{{ lang_result.language }}">
          <!-- 语言统计 -->
          <div class="language-stats">
            <div class="lang-stat-card">
              <span class="lang-stat-icon">👥</span>
              <div class="lang-stat-value">{{ lang_result.unique_users }}</div>
              <div class="lang-stat-label">用户数</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">📝</span>
              <div class="lang-stat-value">{{ lang_result.submission_count }}</div>
              <div class="lang-stat-label">提交数</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">⚠️</span>
              <div class="lang-stat-value">{{ lang_result.high_similarity_pairs | length }}</div>
              <div class="lang-stat-label">高相似度对</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">📊</span>
              <div class="lang-stat-value">{{ "%.1f%%" | format(lang_result.avg_similarity * 100) if lang_result.avg_similarity else 'N/A' }}</div>
              <div class="lang-stat-label">平均相似度</div>
            </div>
          </div>

          <!-- 相似度对列表 -->
          <div class="similarity-pairs">
            <div class="pairs-header">
              <h3 class="pairs-title">相似度检测结果</h3>
              <div class="pairs-filter">
                <label for="similarity-filter-{{ lang_result.language }}">相似度筛选:</label>
                <select class="filter-select" id="similarity-filter-{{ lang_result.language }}" 
                        onchange="filterSimilarityPairs('{{ lang_result.language }}', this.value)">
                  <option value="all">全部</option>
                  <option value="high">高相似度 (>70%)</option>
                  <option value="medium">中等相似度 (30-70%)</option>
                  <option value="low">低相似度 (<30%)</option>
                </select>
              </div>
            </div>

            {% if lang_result.similarity_pairs %}
              {% for pair in lang_result.similarity_pairs %}
              <div class="similarity-pair" data-similarity="{{ pair.avg_similarity }}">
                <div class="pair-header" onclick="togglePairDetails('pair-{{ lang_result.language }}-{{ loop.index }}')">
                  <div class="pair-info">
                    <div class="pair-users">
                      <span class="user-badge">用户 {{ pair.first_user_id }}</span>
                      <span class="vs-divider">VS</span>
                      <span class="user-badge">用户 {{ pair.second_user_id }}</span>
                    </div>
                  </div>
                  <div class="pair-similarity">
                    <div class="similarity-value {% if pair.avg_similarity < 0.3 %}similarity-value--low{% elif pair.avg_similarity < 0.7 %}similarity-value--medium{% else %}similarity-value--high{% endif %}">
                      {{ "%.1f%%" | format(pair.avg_similarity * 100) }}
                    </div>
                    <button class="pair-expand" id="expand-pair-{{ lang_result.language }}-{{ loop.index }}">
                      ▼
                    </button>
                  </div>
                </div>

                <div class="pair-details" id="pair-{{ lang_result.language }}-{{ loop.index }}">
                  <!-- 匹配统计 -->
                  <div class="match-stats">
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.matched_tokens }}</div>
                      <div class="match-stat-label">匹配Token数</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.total_comparisons }}</div>
                      <div class="match-stat-label">比较次数</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ "%.1f%%" | format(pair.max_similarity * 100) if pair.max_similarity else 'N/A' }}</div>
                      <div class="match-stat-label">最大相似度</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.match_length | default('N/A') }}</div>
                      <div class="match-stat-label">匹配长度</div>
                    </div>
                  </div>

                  <!-- 代码匹配展示 -->
                  {% if pair.code_matches %}
                  <div class="code-matches">
                    <div class="code-panel">
                      <div class="code-header">
                        <div class="code-user">
                          <span>👤</span> 用户 {{ pair.first_user_id }}
                        </div>
                        <div class="code-stats">
                          {{ pair.first_submission.file_count | default(1) }} 文件 | {{ pair.first_submission.total_tokens | default('N/A') }} Tokens
                        </div>
                      </div>
                      <div class="code-content">
                        {% for line in pair.first_code_lines %}
                        <div class="code-line">
                          <span class="code-line-number">{{ loop.index }}</span>
                          {% if line.is_match %}
                          <span class="code-highlight">{{ line.content }}</span>
                          {% else %}
                          <span>{{ line.content }}</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="code-panel">
                      <div class="code-header">
                        <div class="code-user">
                          <span>👤</span> 用户 {{ pair.second_user_id }}
                        </div>
                        <div class="code-stats">
                          {{ pair.second_submission.file_count | default(1) }} 文件 | {{ pair.second_submission.total_tokens | default('N/A') }} Tokens
                        </div>
                      </div>
                      <div class="code-content">
                        {% for line in pair.second_code_lines %}
                        <div class="code-line">
                          <span class="code-line-number">{{ loop.index }}</span>
                          {% if line.is_match %}
                          <span class="code-highlight">{{ line.content }}</span>
                          {% else %}
                          <span>{{ line.content }}</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                  {% else %}
                  <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <span style="font-size: 3rem;">📄</span>
                    <p>代码匹配详情正在加载中...</p>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            {% else %}
              {% if lang_result.submission_count < 2 %}
              <div class="empty-state">
                <div class="empty-state-icon">❌</div>
                <h3>提交数量不足</h3>
                <p>该语言只有 {{ lang_result.submission_count }} 个提交，至少需要 2 个提交才能进行查重分析。</p>
              </div>
              {% else %}
              <div class="empty-state">
                <div class="empty-state-icon">✅</div>
                <h3>未发现高相似度代码</h3>
                <p>该语言的所有提交都具有较好的独创性，未检测到明显的代码相似性。</p>
              </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
// 标签切换功能
function switchTab(language) {
  // 隐藏所有标签内容
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // 移除所有按钮的active状态
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // 显示选中的标签内容
  document.getElementById('tab-' + language).classList.add('active');
  
  // 激活选中的按钮
  event.target.classList.add('active');
}

// 展开/收起相似度对详情
function togglePairDetails(pairId) {
  const details = document.getElementById(pairId);
  const expandBtn = document.getElementById('expand-' + pairId);
  
  if (details.classList.contains('expanded')) {
    details.classList.remove('expanded');
    expandBtn.classList.remove('expanded');
  } else {
    details.classList.add('expanded');
    expandBtn.classList.add('expanded');
  }
}

// 相似度筛选
function filterSimilarityPairs(language, filterValue) {
  const pairs = document.querySelectorAll(`#tab-${language} .similarity-pair`);
  
  pairs.forEach(pair => {
    const similarity = parseFloat(pair.dataset.similarity);
    let show = true;
    
    switch (filterValue) {
      case 'high':
        show = similarity > 0.7;
        break;
      case 'medium':
        show = similarity >= 0.3 && similarity <= 0.7;
        break;
      case 'low':
        show = similarity < 0.3;
        break;
      case 'all':
      default:
        show = true;
        break;
    }
    
    pair.style.display = show ? 'block' : 'none';
  });
}

// 页面加载动画
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.problem-detail-container');
  const elements = document.querySelectorAll('.page-header, .language-tabs');
  
  container.style.opacity = '0';
  container.style.transform = 'translateY(20px)';
  container.style.transition = 'all 0.6s ease';
  
  elements.forEach((element, index) => {
    element.style.opacity = '0';
    element.style.transform = 'translateY(30px)';
    element.style.transition = `all 0.6s ease ${index * 0.1}s`;
  });
  
  setTimeout(() => {
    container.style.opacity = '1';
    container.style.transform = 'translateY(0)';
    
    elements.forEach((element) => {
      element.style.opacity = '1';
      element.style.transform = 'translateY(0)';
    });
  }, 100);
});

// 代码高亮动画
function animateCodeHighlights() {
  const highlights = document.querySelectorAll('.code-highlight');
  highlights.forEach((highlight, index) => {
    highlight.style.animationDelay = `${index * 0.1}s`;
  });
}

// 启动代码高亮动画
setTimeout(animateCodeHighlights, 1000);
</script>
{% endblock %}
