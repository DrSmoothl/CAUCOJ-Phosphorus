{% extends "layout/basic.html" %}
{% block title %}{{ problem.title }} - æŸ¥é‡è¯¦æƒ…{% endblock %}

{% block content %}
<style>
/* é¢˜ç›®æŸ¥é‡è¯¦æƒ…é¡µé¢æ ·å¼ */
.problem-detail-container {
  max-width: 1600px;
  margin: 20px auto;
  padding: 0 20px;
}

.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 40px 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 30px,
    rgba(255,255,255,0.1) 30px,
    rgba(255,255,255,0.1) 60px
  );
  animation: headerAnimation 12s linear infinite;
}

@keyframes headerAnimation {
  0% { transform: translateX(-100px) translateY(-100px) rotate(0deg); }
  100% { transform: translateX(100px) translateY(100px) rotate(360deg); }
}

.header-content {
  position: relative;
  z-index: 1;
}

.problem-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 16px;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 1rem;
  opacity: 0.9;
  margin-bottom: 16px;
}

.breadcrumb a {
  color: white;
  text-decoration: none;
  opacity: 0.8;
}

.breadcrumb a:hover {
  opacity: 1;
  text-decoration: underline;
}

.problem-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 24px;
  font-size: 1rem;
  opacity: 0.9;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* è¯­è¨€æ ‡ç­¾é¡µ */
.language-tabs {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  margin-bottom: 30px;
}

.tabs-header {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.tabs-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.tabs-nav {
  display: flex;
  background: #f8fafc;
  border-bottom: 2px solid #e5e7eb;
}

.tab-button {
  padding: 16px 24px;
  background: none;
  border: none;
  cursor: pointer;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.3s ease;
  border-bottom: 3px solid transparent;
  display: flex;
  align-items: center;
  gap: 8px;
}

.tab-button:hover {
  color: #4facfe;
  background: #f1f5f9;
}

.tab-button.active {
  color: #4facfe;
  border-bottom-color: #4facfe;
  background: white;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* è¯­è¨€ç»Ÿè®¡å¡ç‰‡ */
.language-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  padding: 24px;
  background: #f8fafc;
}

.lang-stat-card {
  background: white;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

.lang-stat-icon {
  font-size: 2rem;
  margin-bottom: 8px;
  display: block;
}

.lang-stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 4px 0;
}

.lang-stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

/* ç›¸ä¼¼åº¦å¯¹åˆ—è¡¨ */
.similarity-pairs {
  padding: 24px;
}

.pairs-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 20px;
}

.pairs-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  margin: 0;
}

.pairs-filter {
  display: flex;
  gap: 12px;
  align-items: center;
}

.filter-select {
  padding: 8px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  background: white;
  font-size: 0.875rem;
}

.filter-select:focus {
  outline: none;
  border-color: #4facfe;
}

/* ç›¸ä¼¼åº¦å¯¹å¡ç‰‡ */
.similarity-pair {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  margin-bottom: 16px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.similarity-pair:hover {
  border-color: #4facfe;
  box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
}

.pair-header {
  background: #f8fafc;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.pair-info {
  display: flex;
  align-items: center;
  gap: 16px;
}

.pair-users {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 600;
  color: #1f2937;
}

.user-badge {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.875rem;
}

.vs-divider {
  color: #6b7280;
  font-weight: 400;
}

.pair-similarity {
  display: flex;
  align-items: center;
  gap: 12px;
}

.similarity-value {
  font-size: 1.25rem;
  font-weight: 700;
  padding: 8px 16px;
  border-radius: 20px;
}

.similarity-value--low {
  background: #d1fae5;
  color: #059669;
}

.similarity-value--medium {
  background: #fef3c7;
  color: #d97706;
}

.similarity-value--high {
  background: #fee2e2;
  color: #dc2626;
}

.pair-expand {
  background: none;
  border: none;
  color: #6b7280;
  cursor: pointer;
  font-size: 1.2rem;
  transition: transform 0.3s ease;
}

.pair-expand.expanded {
  transform: rotate(180deg);
}

.pair-details {
  padding: 20px;
  border-top: 1px solid #e5e7eb;
  display: none;
}

.pair-details.expanded {
  display: block;
}

/* ä»£ç åŒ¹é…å±•ç¤º */
.code-matches {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.code-panel {
  background: #1f2937;
  border-radius: 8px;
  overflow: hidden;
}

.code-header {
  background: #374151;
  color: white;
  padding: 12px 16px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.code-user {
  display: flex;
  align-items: center;
  gap: 8px;
}

.code-stats {
  font-size: 0.875rem;
  opacity: 0.8;
}

.code-content {
  padding: 16px;
  color: #f3f4f6;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.875rem;
  line-height: 1.5;
  max-height: 400px;
  overflow-y: auto;
}

.code-line {
  position: relative;
  padding: 2px 0;
}

.code-line-number {
  display: inline-block;
  width: 40px;
  color: #6b7280;
  text-align: right;
  margin-right: 16px;
  user-select: none;
}

.code-highlight {
  background: rgba(239, 68, 68, 0.3);
  padding: 0 4px;
  border-radius: 3px;
  animation: highlightPulse 2s infinite;
}

@keyframes highlightPulse {
  0%, 100% { background: rgba(239, 68, 68, 0.3); }
  50% { background: rgba(239, 68, 68, 0.5); }
}

/* åŒ¹é…ç»Ÿè®¡ */
.match-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

.match-stat {
  background: #f8fafc;
  border-radius: 8px;
  padding: 12px;
  text-align: center;
}

.match-stat-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: #1f2937;
  margin: 0 0 4px 0;
}

.match-stat-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin: 0;
}

/* ç©ºçŠ¶æ€ */
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  opacity: 0.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .problem-detail-container {
    padding: 0 16px;
  }
  
  .page-header {
    padding: 30px 20px;
  }
  
  .problem-title {
    font-size: 2rem;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .tabs-nav {
    flex-wrap: wrap;
  }
  
  .tab-button {
    flex: 1;
    min-width: 120px;
  }
  
  .language-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .code-matches {
    grid-template-columns: 1fr;
  }
  
  .pair-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
}

/* sectioné‡ç½® */
.section {
  background: transparent;
  box-shadow: none;
}

.section__header {
  display: none;
}

.section__body {
  padding: 0;
}
</style>

<div class="section">
  <div class="section__body">
    <div class="problem-detail-container">
      <!-- é¡µé¢å¤´éƒ¨ -->
      <div class="page-header">
        <div class="header-content">
          <div class="breadcrumb">
            <a href="/plagiarism">æŸ¥é‡ç³»ç»Ÿ</a>
            <span>â€º</span>
            <a href="/plagiarism/contest">æ¯”èµ›æŸ¥é‡</a>
            <span>â€º</span>
            <a href="/plagiarism/contest/{{ contest.id }}">{{ contest.title }}</a>
            <span>â€º</span>
            <span>{{ problem.title }}</span>
          </div>
          <h1 class="problem-title">
            <span>ğŸ“„</span> {{ problem.title }}
          </h1>
          <div class="problem-meta">
            <div class="meta-item">
              <span>ğŸ†”</span>
              <span>é¢˜ç›® ID: {{ problem.id }}</span>
            </div>
            <div class="meta-item">
              <span>ğŸ“Š</span>
              <span>{{ problem.total_submissions }} æ€»æäº¤</span>
            </div>
            <div class="meta-item">
              <span>âœ…</span>
              <span>{{ problem.accepted_submissions }} é€šè¿‡</span>
            </div>
            <div class="meta-item">
              <span>ğŸ•’</span>
              <span>{{ problem.last_check_at.strftime('%Y-%m-%d %H:%M') if problem.last_check_at else 'æœªæ£€æŸ¥' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- è¯­è¨€æ ‡ç­¾é¡µ -->
      <div class="language-tabs">
        <div class="tabs-header">
          <h2 class="tabs-title">
            <span>ğŸŒ</span> åˆ†è¯­è¨€æŸ¥é‡ç»“æœ
          </h2>
        </div>

        <!-- æ ‡ç­¾å¯¼èˆª -->
        <div class="tabs-nav">
          {% for lang_result in language_results %}
          <button class="tab-button {% if loop.first %}active{% endif %}" 
                  onclick="switchTab('{{ lang_result.language }}')">
            <span>{{ lang_result.language_icon }}</span>
            {{ lang_result.language_display }}
            <span style="background: rgba(79, 172, 254, 0.2); color: #0369a1; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
              {{ lang_result.submission_count }}
            </span>
          </button>
          {% endfor %}
          {% if not language_results %}
          <div style="padding: 20px; text-align: center; color: #6b7280;">
            <span>âŒ</span> è¯¥é¢˜ç›®æš‚æ— å¯åˆ†æçš„è¯­è¨€æäº¤
          </div>
          {% endif %}
        </div>

        <!-- æ ‡ç­¾å†…å®¹ -->
        {% for lang_result in language_results %}
        <div class="tab-content {% if loop.first %}active{% endif %}" id="tab-{{ lang_result.language }}">
          <!-- è¯­è¨€ç»Ÿè®¡ -->
          <div class="language-stats">
            <div class="lang-stat-card">
              <span class="lang-stat-icon">ğŸ‘¥</span>
              <div class="lang-stat-value">{{ lang_result.unique_users }}</div>
              <div class="lang-stat-label">ç”¨æˆ·æ•°</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">ğŸ“</span>
              <div class="lang-stat-value">{{ lang_result.submission_count }}</div>
              <div class="lang-stat-label">æäº¤æ•°</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">âš ï¸</span>
              <div class="lang-stat-value">{{ lang_result.high_similarity_pairs | length }}</div>
              <div class="lang-stat-label">é«˜ç›¸ä¼¼åº¦å¯¹</div>
            </div>
            <div class="lang-stat-card">
              <span class="lang-stat-icon">ğŸ“Š</span>
              <div class="lang-stat-value">{{ "%.1f%%" | format(lang_result.avg_similarity * 100) if lang_result.avg_similarity else 'N/A' }}</div>
              <div class="lang-stat-label">å¹³å‡ç›¸ä¼¼åº¦</div>
            </div>
          </div>

          <!-- ç›¸ä¼¼åº¦å¯¹åˆ—è¡¨ -->
          <div class="similarity-pairs">
            <div class="pairs-header">
              <h3 class="pairs-title">ç›¸ä¼¼åº¦æ£€æµ‹ç»“æœ</h3>
              <div class="pairs-filter">
                <label for="similarity-filter-{{ lang_result.language }}">ç›¸ä¼¼åº¦ç­›é€‰:</label>
                <select class="filter-select" id="similarity-filter-{{ lang_result.language }}" 
                        onchange="filterSimilarityPairs('{{ lang_result.language }}', this.value)">
                  <option value="all">å…¨éƒ¨</option>
                  <option value="high">é«˜ç›¸ä¼¼åº¦ (>70%)</option>
                  <option value="medium">ä¸­ç­‰ç›¸ä¼¼åº¦ (30-70%)</option>
                  <option value="low">ä½ç›¸ä¼¼åº¦ (<30%)</option>
                </select>
              </div>
            </div>

            {% if lang_result.similarity_pairs %}
              {% for pair in lang_result.similarity_pairs %}
              <div class="similarity-pair" data-similarity="{{ pair.avg_similarity }}">
                <div class="pair-header" onclick="togglePairDetails('pair-{{ lang_result.language }}-{{ loop.index }}')">
                  <div class="pair-info">
                    <div class="pair-users">
                      <span class="user-badge">ç”¨æˆ· {{ pair.first_user_id }}</span>
                      <span class="vs-divider">VS</span>
                      <span class="user-badge">ç”¨æˆ· {{ pair.second_user_id }}</span>
                    </div>
                  </div>
                  <div class="pair-similarity">
                    <div class="similarity-value {% if pair.avg_similarity < 0.3 %}similarity-value--low{% elif pair.avg_similarity < 0.7 %}similarity-value--medium{% else %}similarity-value--high{% endif %}">
                      {{ "%.1f%%" | format(pair.avg_similarity * 100) }}
                    </div>
                    <button class="pair-expand" id="expand-pair-{{ lang_result.language }}-{{ loop.index }}">
                      â–¼
                    </button>
                  </div>
                </div>

                <div class="pair-details" id="pair-{{ lang_result.language }}-{{ loop.index }}">
                  <!-- åŒ¹é…ç»Ÿè®¡ -->
                  <div class="match-stats">
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.matched_tokens }}</div>
                      <div class="match-stat-label">åŒ¹é…Tokenæ•°</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.total_comparisons }}</div>
                      <div class="match-stat-label">æ¯”è¾ƒæ¬¡æ•°</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ "%.1f%%" | format(pair.max_similarity * 100) if pair.max_similarity else 'N/A' }}</div>
                      <div class="match-stat-label">æœ€å¤§ç›¸ä¼¼åº¦</div>
                    </div>
                    <div class="match-stat">
                      <div class="match-stat-value">{{ pair.match_length | default('N/A') }}</div>
                      <div class="match-stat-label">åŒ¹é…é•¿åº¦</div>
                    </div>
                  </div>

                  <!-- ä»£ç åŒ¹é…å±•ç¤º -->
                  {% if pair.code_matches %}
                  <div class="code-matches">
                    <div class="code-panel">
                      <div class="code-header">
                        <div class="code-user">
                          <span>ğŸ‘¤</span> ç”¨æˆ· {{ pair.first_user_id }}
                        </div>
                        <div class="code-stats">
                          {{ pair.first_submission.file_count | default(1) }} æ–‡ä»¶ | {{ pair.first_submission.total_tokens | default('N/A') }} Tokens
                        </div>
                      </div>
                      <div class="code-content">
                        {% for line in pair.first_code_lines %}
                        <div class="code-line">
                          <span class="code-line-number">{{ loop.index }}</span>
                          {% if line.is_match %}
                          <span class="code-highlight">{{ line.content }}</span>
                          {% else %}
                          <span>{{ line.content }}</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>

                    <div class="code-panel">
                      <div class="code-header">
                        <div class="code-user">
                          <span>ğŸ‘¤</span> ç”¨æˆ· {{ pair.second_user_id }}
                        </div>
                        <div class="code-stats">
                          {{ pair.second_submission.file_count | default(1) }} æ–‡ä»¶ | {{ pair.second_submission.total_tokens | default('N/A') }} Tokens
                        </div>
                      </div>
                      <div class="code-content">
                        {% for line in pair.second_code_lines %}
                        <div class="code-line">
                          <span class="code-line-number">{{ loop.index }}</span>
                          {% if line.is_match %}
                          <span class="code-highlight">{{ line.content }}</span>
                          {% else %}
                          <span>{{ line.content }}</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                  {% else %}
                  <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <span style="font-size: 3rem;">ğŸ“„</span>
                    <p>ä»£ç åŒ¹é…è¯¦æƒ…æ­£åœ¨åŠ è½½ä¸­...</p>
                  </div>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            {% else %}
              {% if lang_result.submission_count < 2 %}
              <div class="empty-state">
                <div class="empty-state-icon">âŒ</div>
                <h3>æäº¤æ•°é‡ä¸è¶³</h3>
                <p>è¯¥è¯­è¨€åªæœ‰ {{ lang_result.submission_count }} ä¸ªæäº¤ï¼Œè‡³å°‘éœ€è¦ 2 ä¸ªæäº¤æ‰èƒ½è¿›è¡ŒæŸ¥é‡åˆ†æã€‚</p>
              </div>
              {% else %}
              <div class="empty-state">
                <div class="empty-state-icon">âœ…</div>
                <h3>æœªå‘ç°é«˜ç›¸ä¼¼åº¦ä»£ç </h3>
                <p>è¯¥è¯­è¨€çš„æ‰€æœ‰æäº¤éƒ½å…·æœ‰è¾ƒå¥½çš„ç‹¬åˆ›æ€§ï¼Œæœªæ£€æµ‹åˆ°æ˜æ˜¾çš„ä»£ç ç›¸ä¼¼æ€§ã€‚</p>
              </div>
              {% endif %}
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
// æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
function switchTab(language) {
  // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
  document.getElementById('tab-' + language).classList.add('active');
  
  // æ¿€æ´»é€‰ä¸­çš„æŒ‰é’®
  event.target.classList.add('active');
}

// å±•å¼€/æ”¶èµ·ç›¸ä¼¼åº¦å¯¹è¯¦æƒ…
function togglePairDetails(pairId) {
  const details = document.getElementById(pairId);
  const expandBtn = document.getElementById('expand-' + pairId);
  
  if (details.classList.contains('expanded')) {
    details.classList.remove('expanded');
    expandBtn.classList.remove('expanded');
  } else {
    details.classList.add('expanded');
    expandBtn.classList.add('expanded');
  }
}

// ç›¸ä¼¼åº¦ç­›é€‰
function filterSimilarityPairs(language, filterValue) {
  const pairs = document.querySelectorAll(`#tab-${language} .similarity-pair`);
  
  pairs.forEach(pair => {
    const similarity = parseFloat(pair.dataset.similarity);
    let show = true;
    
    switch (filterValue) {
      case 'high':
        show = similarity > 0.7;
        break;
      case 'medium':
        show = similarity >= 0.3 && similarity <= 0.7;
        break;
      case 'low':
        show = similarity < 0.3;
        break;
      case 'all':
      default:
        show = true;
        break;
    }
    
    pair.style.display = show ? 'block' : 'none';
  });
}

// é¡µé¢åŠ è½½åŠ¨ç”»
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.problem-detail-container');
  const elements = document.querySelectorAll('.page-header, .language-tabs');
  
  container.style.opacity = '0';
  container.style.transform = 'translateY(20px)';
  container.style.transition = 'all 0.6s ease';
  
  elements.forEach((element, index) => {
    element.style.opacity = '0';
    element.style.transform = 'translateY(30px)';
    element.style.transition = `all 0.6s ease ${index * 0.1}s`;
  });
  
  setTimeout(() => {
    container.style.opacity = '1';
    container.style.transform = 'translateY(0)';
    
    elements.forEach((element) => {
      element.style.opacity = '1';
      element.style.transform = 'translateY(0)';
    });
  }, 100);
});

// ä»£ç é«˜äº®åŠ¨ç”»
function animateCodeHighlights() {
  const highlights = document.querySelectorAll('.code-highlight');
  highlights.forEach((highlight, index) => {
    highlight.style.animationDelay = `${index * 0.1}s`;
  });
}

// å¯åŠ¨ä»£ç é«˜äº®åŠ¨ç”»
setTimeout(animateCodeHighlights, 1000);
</script>
{% endblock %}
