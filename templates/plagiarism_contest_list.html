{% extends "layout/basic.html" %}
{% block title %}查重记录 - 比赛列表{% endblock %}

{% block content %}
<!-- 基础调试信息 -->
<div style="background: yellow; padding: 10px; margin: 10px; border: 2px solid red;">
  <h2>🐛 模板调试信息</h2>
  <p><strong>模板已加载:</strong> plagiarism_contest_list.html</p>
  <p><strong>contests 变量:</strong> {{ contests }}</p>
  <p><strong>contests 类型:</strong> {{ contests.__class__.__name__ if contests else 'None' }}</p>
  <p><strong>contests 长度:</strong> {{ contests|length if contests else 'N/A' }}</p>
  <p><strong>error 变量:</strong> {{ error if error else 'None' }}</p>
</div>
<style>
/* 比赛列表页面样式 */
.contest-list-container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 0 20px;
}

.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 40px 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 30px,
    rgba(255,255,255,0.1) 30px,
    rgba(255,255,255,0.1) 60px
  );
  animation: headerAnimation 12s linear infinite;
}

@keyframes headerAnimation {
  0% { transform: translateX(-100px) translateY(-100px) rotate(0deg); }
  100% { transform: translateX(100px) translateY(100px) rotate(360deg); }
}

.header-content {
  position: relative;
  z-index: 1;
}

.page-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 12px 0;
}

.page-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  margin: 0;
}

.controls-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.search-box {
  display: flex;
  align-items: center;
  gap: 12px;
}

.search-input {
  padding: 10px 16px;
  border: 2px solid #e1e5e9;
  border-radius: 8px;
  font-size: 14px;
  width: 300px;
  transition: all 0.3s ease;
}

.search-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: #f8f9fa;
  color: #495057;
  border: 2px solid #e9ecef;
}

.btn-secondary:hover {
  background: #e9ecef;
  transform: translateY(-1px);
}

.contests-grid {
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
}

.contest-card {
  background: white;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border: 2px solid transparent;
  position: relative;
  overflow: hidden;
}

.contest-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.contest-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
  border-color: #667eea;
}

.contest-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
}

.contest-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #2d3748;
  margin: 0 0 8px 0;
  line-height: 1.3;
}

.contest-status {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-completed {
  background: #d4edda;
  color: #155724;
}

.status-processing {
  background: #fff3cd;
  color: #856404;
}

.status-pending {
  background: #f8d7da;
  color: #721c24;
}

.contest-meta {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #6b7280;
}

.meta-icon {
  width: 16px;
  height: 16px;
  opacity: 0.7;
}

.contest-stats {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  padding: 16px;
  background: #f8f9fa;
  border-radius: 12px;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #667eea;
  margin: 0 0 4px 0;
}

.stat-label {
  font-size: 12px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0;
}

.contest-actions {
  display: flex;
  gap: 12px;
}

.btn-sm {
  padding: 8px 16px;
  font-size: 13px;
}

.btn-outline {
  background: transparent;
  border: 2px solid #667eea;
  color: #667eea;
}

.btn-outline:hover {
  background: #667eea;
  color: white;
}

.empty-state {
  text-align: center;
  padding: 80px 20px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.empty-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 24px;
  opacity: 0.3;
}

.empty-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #4a5568;
  margin: 0 0 12px 0;
}

.empty-description {
  color: #6b7280;
  margin: 0 0 24px 0;
  line-height: 1.6;
}

.error-message {
  background: #fee2e2;
  border: 2px solid #fecaca;
  color: #991b1b;
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.error-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid #f3f3f3;
  border-top: 3px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 响应式设计 */
@media (max-width: 768px) {
  .contest-list-container {
    padding: 0 15px;
  }
  
  .page-header {
    padding: 30px 20px;
  }
  
  .page-title {
    font-size: 2rem;
  }
  
  .controls-bar {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }
  
  .search-box {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-input {
    width: 100%;
  }
  
  .contests-grid {
    grid-template-columns: 1fr;
  }
  
  .contest-meta {
    grid-template-columns: 1fr;
  }
  
  .contest-actions {
    flex-direction: column;
  }
}
</style>

<div class="contest-list-container">
  <!-- 页面头部 -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">🔍 查重记录</h1>
      <p class="page-subtitle">浏览所有已进行查重分析的比赛</p>
    </div>
  </div>

  <!-- 错误提示 -->
  {% if error %}
  <div class="error-message">
    <svg class="error-icon" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
    </svg>
    <span>加载比赛列表时出错：{{ error }}</span>
  </div>
  {% endif %}

  <!-- 控制栏 -->
  <div class="controls-bar">
    <div class="search-box">
      <input type="text" class="search-input" placeholder="搜索比赛名称..." id="searchInput">
      <button class="btn btn-secondary" onclick="searchContests()">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
        </svg>
        搜索
      </button>
    </div>
    
    <div>
      <a href="/plagiarism/new" class="btn btn-primary">
        <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
        </svg>
        新建查重任务
      </a>
    </div>
  </div>

  <!-- 比赛列表 -->
  {% if contests and contests|length > 0 %}
  <div class="contests-grid" id="contestsGrid">
    {% for contest in contests %}
    <div class="contest-card" data-search="{{ contest.title|lower }}">
      <div class="contest-header">
        <div>
          <h3 class="contest-title">{{ contest.title or ('比赛 ' + contest.id) }}</h3>
          <div class="contest-status status-{{ contest.status|lower or 'unknown' }}">
            {% if contest.status == 'completed' %}
              已完成
            {% elif contest.status == 'processing' %}
              处理中
            {% else %}
              待处理
            {% endif %}
          </div>
        </div>
      </div>

      <div class="contest-meta">
        <div class="meta-item">
          <svg class="meta-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
          </svg>
          <span>
            {% if contest.begin_at %}
              {{ contest.begin_at }}
            {% else %}
              未设置开始时间
            {% endif %}
          </span>
        </div>
        
        <div class="meta-item">
          <svg class="meta-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
          </svg>
          <span>
            {% if contest.last_check_at %}
              {{ contest.last_check_at.toLocaleString() }}
            {% else %}
              从未检查
            {% endif %}
          </span>
        </div>
      </div>

      <div class="contest-stats">
        <div class="stat-item">
          <div class="stat-value">{{ contest.total_problems or 0 }}</div>
          <div class="stat-label">题目数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ contest.total_submissions or 0 }}</div>
          <div class="stat-label">提交数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ contest.high_similarity_pairs or 0 }}</div>
          <div class="stat-label">高相似度</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ (contest.avg_similarity * 100)|round|int if contest.avg_similarity else 0 }}%</div>
          <div class="stat-label">平均相似度</div>
        </div>
      </div>

      <div class="contest-actions">
        <a href="/plagiarism/contest/{{ contest.id }}" class="btn btn-outline btn-sm">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
          </svg>
          查看详情
        </a>
        {% if contest.status == 'completed' %}
        <button class="btn btn-secondary btn-sm" onclick="downloadResults('{{ contest.id }}')">
          <svg width="14" height="14" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          下载报告
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <!-- 空状态 -->
  <div class="empty-state">
    <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
    </svg>
    <h3 class="empty-title">暂无查重记录</h3>
    <p class="empty-description">还没有进行过代码查重分析，创建第一个查重任务开始吧！</p>
    <a href="/plagiarism/new" class="btn btn-primary">
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
      </svg>
      创建查重任务
    </a>
  </div>
  {% endif %}
</div>

<script>
// 将服务器端变量传递给客户端
window.phosphorusData = {
  contests: {{ contests|dump if contests else '[]' }},
  error: {{ error|dump if error else 'null' }}
};

// 搜索功能
function searchContests() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const contestCards = document.querySelectorAll('.contest-card');
  
  contestCards.forEach(card => {
    const searchData = card.getAttribute('data-search');
    if (searchData.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

// 实时搜索
document.getElementById('searchInput').addEventListener('input', searchContests);

// 下载结果功能
function downloadResults(contestId) {
  // 创建下载链接
  const link = document.createElement('a');
  link.href = `/plagiarism/contest/${contestId}/download`;
  link.download = `contest_${contestId}_plagiarism_report.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// 键盘快捷键
document.addEventListener('keydown', function(e) {
  // Ctrl+F 聚焦搜索框
  if (e.ctrlKey && e.key === 'f') {
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  
  // Ctrl+N 新建任务
  if (e.ctrlKey && e.key === 'n') {
    e.preventDefault();
    window.location.href = '/plagiarism/new';
  }
});

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
  // 输出调试信息
  console.log('[Phosphorus Template] Page loaded');
  console.log('[Phosphorus Template] phosphorusData:', window.phosphorusData);
  console.log('[Phosphorus Template] contests variable:', window.phosphorusData.contests);
  console.log('[Phosphorus Template] contests length:', window.phosphorusData.contests ? window.phosphorusData.contests.length : 'null');
  console.log('[Phosphorus Template] error variable:', window.phosphorusData.error);
  
  // 聚焦搜索框
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.focus();
  }
  
  // 显示加载提示
  const contestsGrid = document.getElementById('contestsGrid');
  if (contestsGrid && contestsGrid.children.length === 0) {
    contestsGrid.innerHTML = `
      <div style="text-align: center; padding: 40px; grid-column: 1 / -1;">
        <div class="loading-spinner"></div>
        <p style="margin-top: 16px; color: #6b7280;">正在加载比赛数据...</p>
      </div>
    `;
  }
});
</script>

{% endblock %}
