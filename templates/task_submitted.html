{% extends "layout/basic.html" %}
{% block title %}æŸ¥é‡ä»»åŠ¡å·²æäº¤{% endblock %}

{% block content %}
<style>
/* ä»»åŠ¡æäº¤æˆåŠŸé¡µé¢æ ·å¼ */
.task-submitted-container {
  max-width: 800px;
  margin: 40px auto;
  padding: 0 20px;
}

.success-header {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 40px 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.success-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 30px,
    rgba(255,255,255,0.1) 30px,
    rgba(255,255,255,0.1) 60px
  );
  animation: headerAnimation 15s linear infinite;
}

@keyframes headerAnimation {
  0% { transform: translateX(-100px) translateY(-100px) rotate(0deg); }
  100% { transform: translateX(100px) translateY(100px) rotate(360deg); }
}

.header-content {
  position: relative;
  z-index: 1;
}

.success-icon {
  font-size: 4rem;
  margin-bottom: 16px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-10px);
  }
  60% {
    transform: translateY(-5px);
  }
}

.success-title {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 12px 0;
}

.success-description {
  font-size: 1.1rem;
  opacity: 0.9;
  margin: 0;
}

/* ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ */
.task-info-card {
  background: white;
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  border: 2px solid #e5e7eb;
}

.task-info-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 20px 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.task-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 25px;
}

.detail-item {
  text-align: center;
  padding: 16px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

.detail-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: #1f2937;
  margin-bottom: 4px;
}

.detail-label {
  font-size: 0.875rem;
  color: #6b7280;
}

.task-id {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  margin-top: 20px;
}

.task-id-label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 8px;
}

.task-id-value {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  font-family: monospace;
}

/* ç­‰å¾…çŠ¶æ€æŒ‡ç¤ºå™¨ */
.waiting-indicator {
  background: white;
  border-radius: 16px;
  padding: 30px;
  margin-bottom: 30px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  text-align: center;
}

.progress-ring {
  width: 80px;
  height: 80px;
  margin: 0 auto 20px;
  position: relative;
}

.progress-ring svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.progress-ring circle {
  fill: none;
  stroke-width: 6;
  stroke-linecap: round;
}

.progress-ring .background {
  stroke: #e5e7eb;
}

.progress-ring .progress {
  stroke: #3b82f6;
  stroke-dasharray: 251;
  stroke-dashoffset: 251;
  animation: progress 3s ease-in-out infinite;
}

@keyframes progress {
  0% { stroke-dashoffset: 251; }
  50% { stroke-dashoffset: 125; }
  100% { stroke-dashoffset: 251; }
}

.waiting-text {
  font-size: 1.2rem;
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 8px;
}

.waiting-description {
  color: #6b7280;
  margin-bottom: 20px;
}

.estimated-time {
  background: #fef3c7;
  color: #d97706;
  padding: 12px 20px;
  border-radius: 8px;
  font-weight: 500;
  display: inline-block;
}

/* å¿«æ·æ“ä½œæŒ‰é’® */
.quick-actions {
  background: white;
  border-radius: 16px;
  padding: 30px;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.actions-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 20px 0;
  text-align: center;
}

.action-buttons {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding: 20px;
  background: #f8fafc;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  text-decoration: none;
  color: #374151;
  transition: all 0.3s ease;
  cursor: pointer;
}

.action-btn:hover {
  background: #f3f4f6;
  border-color: #3b82f6;
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
}

.action-btn.primary {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  border-color: #3b82f6;
}

.action-btn.primary:hover {
  background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
  border-color: #1d4ed8;
}

.action-btn.success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border-color: #10b981;
}

.action-btn.success:hover {
  background: linear-gradient(135deg, #059669 0%, #047857 100%);
  border-color: #059669;
}

.action-icon {
  font-size: 2rem;
}

.action-text {
  font-weight: 600;
  text-align: center;
}

.action-description {
  font-size: 0.875rem;
  opacity: 0.8;
  text-align: center;
  margin: 0;
}

/* é€šçŸ¥è®¾ç½® */
.notification-card {
  background: #f0f9ff;
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 20px;
  margin-top: 30px;
}

.notification-title {
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.notification-options {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.notification-option {
  display: flex;
  align-items: center;
  gap: 8px;
  background: white;
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  cursor: pointer;
  transition: all 0.3s ease;
}

.notification-option:hover {
  border-color: #3b82f6;
  background: #f8fafc;
}

.notification-option input[type="checkbox"] {
  accent-color: #3b82f6;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .task-submitted-container {
    padding: 0 16px;
  }
  
  .success-header {
    padding: 30px 20px;
  }
  
  .success-title {
    font-size: 2rem;
  }
  
  .task-details {
    grid-template-columns: 1fr;
  }
  
  .action-buttons {
    grid-template-columns: 1fr;
  }
}

/* è‡ªåŠ¨åˆ·æ–°æç¤º */
.auto-refresh {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #3b82f6;
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 0.875rem;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
  z-index: 1000;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.refresh-countdown {
  font-weight: 600;
  margin-left: 8px;
}
</style>

<div class="task-submitted-container">
  <!-- æˆåŠŸæç¤ºå¤´éƒ¨ -->
  <div class="success-header">
    <div class="header-content">
      <div class="success-icon">âœ…</div>
      <h1 class="success-title">æŸ¥é‡ä»»åŠ¡å·²æˆåŠŸæäº¤ï¼</h1>
      <p class="success-description">æ‚¨çš„ä»£ç æŸ¥é‡åˆ†æä»»åŠ¡æ­£åœ¨åå°å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
    </div>
  </div>

  <!-- ä»»åŠ¡ä¿¡æ¯å¡ç‰‡ -->
  <div class="task-info-card">
    <h2 class="task-info-title">
      <span>ğŸ“‹</span> ä»»åŠ¡è¯¦æƒ…
    </h2>
    
    <div class="task-details">
      <div class="detail-item">
        <div class="detail-value">{{ contest_name }}</div>
        <div class="detail-label">æ¯”èµ›åç§°</div>
      </div>
      <div class="detail-item">
        <div class="detail-value">{{ problem_count }}</div>
        <div class="detail-label">é€‰æ‹©é¢˜ç›®</div>
      </div>
      <div class="detail-item">
        <div class="detail-value">{{ min_tokens }}</div>
        <div class="detail-label">æœ€å°Tokenæ•°</div>
      </div>
      <div class="detail-item">
        <div class="detail-value">{{ similarity_threshold }}%</div>
        <div class="detail-label">ç›¸ä¼¼åº¦é˜ˆå€¼</div>
      </div>
    </div>

    {% if task_id %}
    <div class="task-id">
      <div class="task-id-label">ä»»åŠ¡IDï¼ˆç”¨äºæŸ¥è¯¢è¿›åº¦ï¼‰</div>
      <div class="task-id-value">{{ task_id }}</div>
    </div>
    {% endif %}
  </div>

  <!-- ç­‰å¾…çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <div class="waiting-indicator">
    <div class="progress-ring">
      <svg viewBox="0 0 84 84">
        <circle class="background" cx="42" cy="42" r="40"></circle>
        <circle class="progress" cx="42" cy="42" r="40"></circle>
      </svg>
    </div>
    <div class="waiting-text">æ­£åœ¨åˆ†æä»£ç ç›¸ä¼¼æ€§</div>
    <div class="waiting-description">
      ç³»ç»Ÿæ­£åœ¨å¯¹æäº¤çš„ä»£ç è¿›è¡Œæ·±åº¦åˆ†æï¼Œæ£€æµ‹æ½œåœ¨çš„æŠ„è¢­è¡Œä¸º
    </div>
    <div class="estimated-time">
      â±ï¸ é¢„è®¡å¤„ç†æ—¶é—´ï¼š{{ estimated_time || '30-60åˆ†é’Ÿ' }}
    </div>
  </div>

  <!-- å¿«æ·æ“ä½œæŒ‰é’® -->
  <div class="quick-actions">
    <h3 class="actions-title">æ‚¨å¯ä»¥è¿›è¡Œä»¥ä¸‹æ“ä½œ</h3>
    
    <div class="action-buttons">
      <a href="/plagiarism/contest/{{ contest_id }}" class="action-btn primary">
        <div class="action-icon">ğŸ“Š</div>
        <div class="action-text">æŸ¥çœ‹ç»“æœ</div>
        <div class="action-description">æŸ¥çœ‹å·²å®Œæˆçš„æŸ¥é‡ç»“æœ</div>
      </a>
      
      <a href="/plagiarism/new" class="action-btn">
        <div class="action-icon">â•</div>
        <div class="action-text">æ–°å»ºä»»åŠ¡</div>
        <div class="action-description">åˆ›å»ºå¦ä¸€ä¸ªæŸ¥é‡ä»»åŠ¡</div>
      </a>
      
      <a href="/plagiarism/contest" class="action-btn">
        <div class="action-icon">ğŸ“‹</div>
        <div class="action-text">ä»»åŠ¡åˆ—è¡¨</div>
        <div class="action-description">æŸ¥çœ‹æ‰€æœ‰æŸ¥é‡ä»»åŠ¡</div>
      </a>
      
      <a href="/plagiarism" class="action-btn success">
        <div class="action-icon">ğŸ </div>
        <div class="action-text">è¿”å›é¦–é¡µ</div>
        <div class="action-description">å›åˆ°æŸ¥é‡ç³»ç»Ÿé¦–é¡µ</div>
      </a>
    </div>
  </div>

  <!-- é€šçŸ¥è®¾ç½® -->
  <div class="notification-card">
    <h4 class="notification-title">
      <span>ğŸ””</span> é€šçŸ¥è®¾ç½®
    </h4>
    <div class="notification-options">
      <label class="notification-option">
        <input type="checkbox" id="emailNotification" checked>
        <span>é‚®ä»¶é€šçŸ¥</span>
      </label>
      <label class="notification-option">
        <input type="checkbox" id="browserNotification">
        <span>æµè§ˆå™¨é€šçŸ¥</span>
      </label>
      <label class="notification-option">
        <input type="checkbox" id="autoRefresh" checked>
        <span>è‡ªåŠ¨åˆ·æ–°</span>
      </label>
    </div>
  </div>
</div>

<!-- è‡ªåŠ¨åˆ·æ–°æç¤º -->
<div class="auto-refresh" id="refreshIndicator" style="display: none;">
  <span>ğŸ”„ é¡µé¢å°†åœ¨</span>
  <span class="refresh-countdown" id="countdown">60</span>
  <span>ç§’åè‡ªåŠ¨åˆ·æ–°</span>
</div>

<script>
// è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
let refreshInterval;
let countdownInterval;
let countdown = 60;

function startAutoRefresh() {
  const autoRefreshCheckbox = document.getElementById('autoRefresh');
  const refreshIndicator = document.getElementById('refreshIndicator');
  const countdownElement = document.getElementById('countdown');
  
  if (autoRefreshCheckbox.checked) {
    refreshIndicator.style.display = 'block';
    
    countdownInterval = setInterval(() => {
      countdown--;
      countdownElement.textContent = countdown;
      
      if (countdown <= 0) {
        window.location.reload();
      }
    }, 1000);
    
    refreshInterval = setTimeout(() => {
      window.location.reload();
    }, 60000);
  } else {
    refreshIndicator.style.display = 'none';
    clearInterval(countdownInterval);
    clearTimeout(refreshInterval);
    countdown = 60;
    countdownElement.textContent = countdown;
  }
}

// æµè§ˆå™¨é€šçŸ¥
function requestNotificationPermission() {
  const browserNotificationCheckbox = document.getElementById('browserNotification');
  
  if (browserNotificationCheckbox.checked && 'Notification' in window) {
    if (Notification.permission === 'default') {
      Notification.requestPermission().then(permission => {
        if (permission !== 'granted') {
          browserNotificationCheckbox.checked = false;
        }
      });
    } else if (Notification.permission === 'denied') {
      browserNotificationCheckbox.checked = false;
      alert('æµè§ˆå™¨é€šçŸ¥å·²è¢«ç¦ç”¨ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¯ç”¨é€šçŸ¥æƒé™');
    }
  }
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
  // è‡ªåŠ¨åˆ·æ–°äº‹ä»¶ç›‘å¬
  document.getElementById('autoRefresh').addEventListener('change', startAutoRefresh);
  
  // æµè§ˆå™¨é€šçŸ¥äº‹ä»¶ç›‘å¬
  document.getElementById('browserNotification').addEventListener('change', requestNotificationPermission);
  
  // é»˜è®¤å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
  startAutoRefresh();
  
  // ä¿å­˜é€šçŸ¥è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
  const checkboxes = document.querySelectorAll('.notification-option input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    // æ¢å¤ä¿å­˜çš„è®¾ç½®
    const saved = localStorage.getItem(checkbox.id);
    if (saved !== null) {
      checkbox.checked = saved === 'true';
    }
    
    // ä¿å­˜è®¾ç½®å˜åŒ–
    checkbox.addEventListener('change', function() {
      localStorage.setItem(this.id, this.checked);
    });
  });
  
  // é¡µé¢åŠ¨ç”»æ•ˆæœ
  const cards = document.querySelectorAll('.task-info-card, .waiting-indicator, .quick-actions');
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(20px)';
    card.style.transition = 'all 0.6s ease';
    
    setTimeout(() => {
      card.style.opacity = '1';
      card.style.transform = 'translateY(0)';
    }, index * 200 + 300);
  });
});

// é¡µé¢ç¦»å¼€å‰æ¸…ç†å®šæ—¶å™¨
window.addEventListener('beforeunload', function() {
  clearInterval(countdownInterval);
  clearTimeout(refreshInterval);
});

// æ£€æŸ¥ä»»åŠ¡çŠ¶æ€çš„å‡½æ•°ï¼ˆå¯ä»¥é€šè¿‡AJAXè°ƒç”¨ï¼‰
async function checkTaskStatus() {
  try {
    const taskId = '{{ task_id }}';
    if (!taskId) return;
    
    const response = await fetch(`/plagiarism/api/task/${taskId}/status`);
    const data = await response.json();
    
    if (data.success && data.status === 'completed') {
      // ä»»åŠ¡å®Œæˆï¼Œæ˜¾ç¤ºé€šçŸ¥å¹¶é‡å®šå‘
      if (document.getElementById('browserNotification').checked && 'Notification' in window && Notification.permission === 'granted') {
        new Notification('æŸ¥é‡ä»»åŠ¡å®Œæˆ', {
          body: 'æ‚¨çš„ä»£ç æŸ¥é‡åˆ†æå·²å®Œæˆï¼Œç‚¹å‡»æŸ¥çœ‹ç»“æœ',
          icon: '/favicon.ico'
        });
      }
      
      // 3ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç»“æœé¡µé¢
      setTimeout(() => {
        window.location.href = `/plagiarism/contest/{{ contest_id }}`;
      }, 3000);
      
      // æ›´æ–°é¡µé¢çŠ¶æ€
      document.querySelector('.waiting-text').textContent = 'åˆ†æå®Œæˆï¼';
      document.querySelector('.waiting-description').textContent = 'æ­£åœ¨è·³è½¬åˆ°ç»“æœé¡µé¢...';
      document.querySelector('.estimated-time').textContent = 'âœ… ä»»åŠ¡å·²å®Œæˆ';
      document.querySelector('.estimated-time').style.background = '#dcfce7';
      document.querySelector('.estimated-time').style.color = '#166534';
    }
  } catch (error) {
    console.warn('æ£€æŸ¥ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
  }
}

// æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€
setInterval(checkTaskStatus, 30000);
</script>
{% endblock %}
