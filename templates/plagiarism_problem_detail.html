{% extends "layout/basic.html" %}
{% block title %}{{ problem.title or ('题目 ' + problem.id|string) }} - 查重详情{% endblock %}

{% block content %}
<style>
/* 题目详情页面样式 */
.problem-detail-container {
  max-width: 1400px;
  margin: 20px auto;
  padding: 0 20px;
}

.page-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 40px 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: repeating-linear-gradient(
    45deg,
    transparent,
    transparent 30px,
    rgba(255,255,255,0.1) 30px,
    rgba(255,255,255,0.1) 60px
  );
  animation: headerAnimation 20s linear infinite;
}

@keyframes headerAnimation {
  0% { transform: translateX(-100px) translateY(-100px) rotate(0deg); }
  100% { transform: translateX(100px) translateY(100px) rotate(360deg); }
}

.header-content {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.header-info h1 {
  font-size: 2.5rem;
  font-weight: 700;
  margin: 0 0 8px 0;
}

.header-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  margin: 0 0 16px 0;
}

.problem-meta {
  display: flex;
  gap: 24px;
  font-size: 14px;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  opacity: 0.9;
}

.header-actions {
  display: flex;
  gap: 12px;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-white {
  background: white;
  color: #667eea;
  border: 2px solid transparent;
}

.btn-white:hover {
  background: #f8f9fa;
  transform: translateY(-2px);
}

.btn-outline-white {
  background: transparent;
  color: white;
  border: 2px solid white;
}

.btn-outline-white:hover {
  background: white;
  color: #667eea;
}

.overview-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.overview-card {
  background: white;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.overview-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.overview-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto 16px;
  padding: 12px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 12px;
  color: white;
}

.overview-value {
  font-size: 2rem;
  font-weight: 700;
  color: #2d3748;
  margin: 0 0 8px 0;
}

.overview-label {
  font-size: 14px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 0;
}

.content-layout {
  display: grid;
  grid-template-columns: 1fr 350px;
  gap: 30px;
}

.main-content {
  min-width: 0;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.sidebar {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.section-card {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  overflow: hidden;
}

.section-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-bottom: 2px solid #e9ecef;
}

.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: #2d3748;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-content {
  padding: 24px;
}

.language-stats {
  display: grid;
  gap: 16px;
}

.language-item {
  background: #f8f9fa;
  border: 2px solid #e9ecef;
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
}

.language-item:hover {
  border-color: #667eea;
  background: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
}

.language-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.language-name {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2d3748;
  display: flex;
  align-items: center;
  gap: 8px;
}

.language-icon {
  width: 24px;
  height: 24px;
  padding: 4px;
  background: #667eea;
  color: white;
  border-radius: 6px;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
}

.similarity-score {
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.score-high {
  background: #fee2e2;
  color: #991b1b;
}

.score-medium {
  background: #fef3c7;
  color: #92400e;
}

.score-low {
  background: #d1fae5;
  color: #065f46;
}

.score-none {
  background: #f3f4f6;
  color: #6b7280;
}

.language-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}

.language-stat {
  text-align: center;
  padding: 12px 8px;
  background: white;
  border-radius: 8px;
}

.language-stat-value {
  font-size: 1.3rem;
  font-weight: 600;
  color: #667eea;
  margin: 0 0 4px 0;
}

.language-stat-label {
  font-size: 11px;
  color: #6b7280;
  text-transform: uppercase;
  margin: 0;
}

.similarity-pairs {
  margin-top: 16px;
}

.pairs-header {
  font-size: 14px;
  font-weight: 600;
  color: #4a5568;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.pair-item {
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  transition: all 0.3s ease;
}

.pair-item:hover {
  border-color: #667eea;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
}

.pair-users {
  font-size: 14px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 4px;
}

.pair-similarity {
  font-size: 13px;
  color: #6b7280;
}

.info-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 2px solid #e9ecef;
}

.info-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #f1f3f4;
}

.info-item:last-child {
  border-bottom: none;
}

.info-label {
  font-weight: 600;
  color: #4a5568;
  font-size: 14px;
}

.info-value {
  color: #6b7280;
  font-size: 14px;
}

.actions-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  border: 2px solid #e9ecef;
}

.action-btn {
  width: 100%;
  margin-bottom: 12px;
  justify-content: center;
}

.action-btn:last-child {
  margin-bottom: 0;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: #f8f9fa;
  color: #495057;
  border: 2px solid #e9ecef;
}

.btn-secondary:hover {
  background: #e9ecef;
  transform: translateY(-1px);
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

.empty-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  opacity: 0.5;
}

.error-message {
  background: #fee2e2;
  border: 2px solid #fecaca;
  color: #991b1b;
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 24px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
  font-size: 14px;
  color: #6b7280;
}

.breadcrumb a {
  color: #667eea;
  text-decoration: none;
}

.breadcrumb a:hover {
  text-decoration: underline;
}

.breadcrumb-separator {
  color: #d1d5db;
}

.chart-container {
  height: 300px;
  margin-top: 20px;
}

.code-comparison {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 20px;
  margin-top: 16px;
  border: 2px solid #e9ecef;
}

.comparison-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #e2e8f0;
}

.comparison-title {
  font-size: 14px;
  font-weight: 600;
  color: #4a5568;
}

.similarity-percentage {
  font-size: 14px;
  font-weight: 600;
  color: #e53e3e;
}

.code-blocks {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.code-block {
  background: #2d3748;
  color: #e2e8f0;
  border-radius: 8px;
  padding: 16px;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
  line-height: 1.5;
  overflow-x: auto;
}

.code-header {
  font-size: 12px;
  color: #a0aec0;
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid #4a5568;
}

/* 响应式设计 */
@media (max-width: 1024px) {
  .content-layout {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    order: -1;
  }
}

@media (max-width: 768px) {
  .problem-detail-container {
    padding: 0 15px;
  }
  
  .page-header {
    padding: 30px 20px;
  }
  
  .header-content {
    flex-direction: column;
    gap: 20px;
  }
  
  .header-info h1 {
    font-size: 2rem;
  }
  
  .problem-meta {
    flex-direction: column;
    gap: 8px;
  }
  
  .overview-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .language-stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .code-blocks {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 480px) {
  .overview-grid {
    grid-template-columns: 1fr;
  }
  
  .language-stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<div class="problem-detail-container">
  <!-- 面包屑导航 -->
  <div class="breadcrumb">
    <a href="/plagiarism">查重系统</a>
    <span class="breadcrumb-separator">›</span>
    <a href="/plagiarism/contest">比赛列表</a>
    <span class="breadcrumb-separator">›</span>
    <a href="/plagiarism/contest/{{ contest.id }}">{{ contest.title or ('比赛 ' + contest.id) }}</a>
    <span class="breadcrumb-separator">›</span>
    <span>{{ problem.title or ('题目 ' + problem.id|string) }}</span>
  </div>

  <!-- 错误提示 -->
  {% if error %}
  <div class="error-message">
    <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
    </svg>
    <span>加载题目详情时出错：{{ error }}</span>
  </div>
  {% endif %}

  {% if contest and problem %}
  <!-- 页面头部 -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1>{{ problem.title or ('题目 ' + problem.id|string) }}</h1>
        <p class="header-subtitle">代码相似度详细分析</p>
        <div class="problem-meta">
          <div class="meta-item">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
            </svg>
            <span>题目ID：{{ problem.id }}</span>
          </div>
          <div class="meta-item">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
            <span>所属比赛：{{ contest.title or ('比赛 ' + contest.id) }}</span>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <a href="/plagiarism/contest/{{ contest.id }}" class="btn btn-outline-white">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
          </svg>
          返回比赛
        </a>
        <button class="btn btn-white" onclick="downloadProblemReport()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          下载报告
        </button>
      </div>
    </div>
  </div>

  <!-- 概览统计 -->
  <div class="overview-grid">
    <div class="overview-card">
      <div class="overview-icon">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1h6v4H5V6zm6 6H5v2h6v-2z" clip-rule="evenodd"></path>
          <path d="M15 7h1a2 2 0 012 2v5.5a1.5 1.5 0 01-3 0V9a1 1 0 00-1-1h-1v1z"></path>
        </svg>
      </div>
      <div class="overview-value">{{ problem.total_submissions or 0 }}</div>
      <div class="overview-label">总提交数</div>
    </div>

    <div class="overview-card">
      <div class="overview-icon">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="overview-value">
        {% set total_pairs = 0 %}
        {% for lang_result in language_results %}
          {% set total_pairs = total_pairs + (lang_result.high_similarity_pairs|length if lang_result.high_similarity_pairs else 0) %}
        {% endfor %}
        {{ total_pairs }}
      </div>
      <div class="overview-label">高相似度对</div>
    </div>

    <div class="overview-card">
      <div class="overview-icon">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M3 3a1 1 0 000 2v8a2 2 0 002 2h2.586l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l2.293 2.293a1 1 0 001.414-1.414L12.414 15H15a2 2 0 002-2V5a1 1 0 100-2H3zm11.707 4.707a1 1 0 00-1.414-1.414L10 9.586 8.707 8.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="overview-value">
        {% set max_similarity = 0 %}
        {% for lang_result in language_results %}
          {% if lang_result.max_similarity and lang_result.max_similarity > max_similarity %}
            {% set max_similarity = lang_result.max_similarity %}
          {% endif %}
        {% endfor %}
        {{ (max_similarity * 100)|round|int }}%
      </div>
      <div class="overview-label">最高相似度</div>
    </div>

    <div class="overview-card">
      <div class="overview-icon">
        <svg fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
      </div>
      <div class="overview-value">{{ language_results|length if language_results else 0 }}</div>
      <div class="overview-label">编程语言</div>
    </div>
  </div>

  <!-- 主要内容布局 -->
  <div class="content-layout">
    <!-- 主内容区域 -->
    <div class="main-content">
      <!-- 语言统计 -->
      <div class="section-card">
        <div class="section-header">
          <h2 class="section-title">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
            编程语言分析
          </h2>
        </div>
        <div class="section-content">
          {% if language_results and language_results|length > 0 %}
          <div class="language-stats">
            {% for lang_result in language_results %}
            <div class="language-item">
              <div class="language-header">
                <div class="language-name">
                  <div class="language-icon">
                    {% if lang_result.language|length >= 2 %}
                      {{ lang_result.language[0]|upper }}{{ lang_result.language[1]|upper }}
                    {% elif lang_result.language|length == 1 %}
                      {{ lang_result.language[0]|upper }}
                    {% else %}
                      UN
                    {% endif %}
                  </div>
                  <span>{{ lang_result.language|title }}</span>
                </div>
                <div class="similarity-score {% if (lang_result.max_similarity or 0) >= 0.8 %}score-high{% elif (lang_result.max_similarity or 0) >= 0.5 %}score-medium{% elif (lang_result.max_similarity or 0) > 0 %}score-low{% else %}score-none{% endif %}">
                  {% if lang_result.max_similarity %}
                    {{ (lang_result.max_similarity * 100)|round|int }}% 相似
                  {% else %}
                    无数据
                  {% endif %}
                </div>
              </div>

              <div class="language-stats-grid">
                <div class="language-stat">
                  <div class="language-stat-value">{{ lang_result.total_submissions or 0 }}</div>
                  <div class="language-stat-label">提交数</div>
                </div>
                <div class="language-stat">
                  <div class="language-stat-value">{{ lang_result.unique_users or 0 }}</div>
                  <div class="language-stat-label">用户数</div>
                </div>
                <div class="language-stat">
                  <div class="language-stat-value">{{ lang_result.high_similarity_pairs|length if lang_result.high_similarity_pairs else 0 }}</div>
                  <div class="language-stat-label">相似对数</div>
                </div>
              </div>

              {% if lang_result.high_similarity_pairs and lang_result.high_similarity_pairs|length > 0 %}
              <div class="similarity-pairs">
                <div class="pairs-header">
                  <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                  </svg>
                  高相似度代码对
                </div>
                {% for pair in lang_result.high_similarity_pairs %}
                {% if loop.index <= 5 %}
                <div class="pair-item">
                  <div class="pair-users">{{ pair.user1 or 'User' }} ↔ {{ pair.user2 or 'User' }}</div>
                  <div class="pair-similarity">相似度：{{ (pair.similarity * 100)|round|int }}%</div>
                </div>
                {% endif %}
                {% endfor %}
                {% if lang_result.high_similarity_pairs|length > 5 %}
                <div style="text-align: center; margin-top: 12px;">
                  <button class="btn btn-secondary" style="padding: 6px 16px; font-size: 13px;" onclick="showAllPairs('{{ lang_result.language }}')">
                    查看全部 {{ lang_result.high_similarity_pairs|length }} 个相似对
                  </button>
                </div>
                {% endif %}
              </div>
              {% endif %}

              {% if lang_result.sample_comparison %}
              <div class="code-comparison">
                <div class="comparison-header">
                  <div class="comparison-title">代码对比示例</div>
                  <div class="similarity-percentage">{{ (lang_result.sample_comparison.similarity * 100)|round|int }}% 相似</div>
                </div>
                <div class="code-blocks">
                  <div class="code-block">
                    <div class="code-header">{{ lang_result.sample_comparison.user1 or 'User A' }}</div>
                    <pre>{{ lang_result.sample_comparison.code1 or '// 代码内容不可用' }}</pre>
                  </div>
                  <div class="code-block">
                    <div class="code-header">{{ lang_result.sample_comparison.user2 or 'User B' }}</div>
                    <pre>{{ lang_result.sample_comparison.code2 or '// 代码内容不可用' }}</pre>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3>暂无分析数据</h3>
            <p>该题目还没有进行查重分析或没有足够的提交数据。</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- 侧边栏 -->
    <div class="sidebar">
      <!-- 题目信息 -->
      <div class="info-card">
        <h3 style="margin-top: 0; color: #2d3748; font-size: 1.1rem;">题目信息</h3>
        <div class="info-item">
          <span class="info-label">题目ID</span>
          <span class="info-value">{{ problem.id }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">标题</span>
          <span class="info-value">{{ problem.title or '未命名' }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">总提交数</span>
          <span class="info-value">{{ problem.total_submissions or 0 }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">通过数</span>
          <span class="info-value">{{ problem.accepted_submissions or 0 }}</span>
        </div>
        {% if problem.difficulty %}
        <div class="info-item">
          <span class="info-label">难度</span>
          <span class="info-value">{{ problem.difficulty }}</span>
        </div>
        {% endif %}
      </div>

      <!-- 比赛信息 -->
      <div class="info-card">
        <h3 style="margin-top: 0; color: #2d3748; font-size: 1.1rem;">比赛信息</h3>
        <div class="info-item">
          <span class="info-label">比赛ID</span>
          <span class="info-value">{{ contest.id }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">比赛名称</span>
          <span class="info-value">{{ contest.title or '未命名' }}</span>
        </div>
        {% if contest.begin_at %}
        <div class="info-item">
          <span class="info-label">开始时间</span>
          <span class="info-value">{{ contest.begin_at }}</span>
        </div>
        {% endif %}
        {% if contest.end_at %}
        <div class="info-item">
          <span class="info-label">结束时间</span>
          <span class="info-value">{{ contest.end_at }}</span>
        </div>
        {% endif %}
      </div>

      <!-- 快捷操作 -->
      <div class="actions-card">
        <h3 style="margin-top: 0; color: #2d3748; font-size: 1.1rem;">快捷操作</h3>
        <button class="btn btn-primary action-btn" onclick="regenerateAnalysis()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
          </svg>
          重新分析
        </button>
        <button class="btn btn-secondary action-btn" onclick="exportDetailedData()">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
          导出详细数据
        </button>
        <a href="/plagiarism/new" class="btn btn-secondary action-btn">
          <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path>
          </svg>
          新建查重任务
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
// 下载题目报告
function downloadProblemReport() {
  const contestId = '{{ contest.id }}';
  const problemId = '{{ problem.id }}';
  const link = document.createElement('a');
  link.href = `/plagiarism/contest/${contestId}/${problemId}/download`;
  link.download = `problem_${problemId}_plagiarism_report.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// 显示所有相似对
function showAllPairs(language) {
  // 这里可以实现一个模态窗口来显示所有相似对
  alert(`显示 ${language} 语言的所有相似代码对`);
}

// 重新分析
function regenerateAnalysis() {
  if (confirm('确定要重新分析这个题目的查重结果吗？这可能需要一些时间。')) {
    const contestId = '{{ contest.id }}';
    const problemId = '{{ problem.id }}';
    
    // 发送重新分析请求
    fetch(`/plagiarism/contest/${contestId}/${problemId}/reanalyze`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('重新分析任务已提交，页面将在几秒后刷新。');
        setTimeout(() => {
          window.location.reload();
        }, 3000);
      } else {
        alert('提交重新分析任务失败：' + (data.message || '未知错误'));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('提交重新分析任务时发生错误');
    });
  }
}

// 导出详细数据
function exportDetailedData() {
  const contestId = '{{ contest.id }}';
  const problemId = '{{ problem.id }}';
  const data = {
    contest: {{ contest | dump if contest else '{}' }},
    problem: {{ problem | dump if problem else '{}' }},
    language_results: {{ language_results | dump if language_results else '[]' }},
    export_time: new Date().toISOString()
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `problem_${problemId}_detailed_export.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// 键盘快捷键
document.addEventListener('keydown', function(e) {
  // Escape 返回比赛
  if (e.key === 'Escape') {
    window.location.href = '/plagiarism/contest/{{ contest.id }}';
  }
  
  // Ctrl+D 下载报告
  if (e.ctrlKey && e.key === 'd') {
    e.preventDefault();
    downloadProblemReport();
  }
});

// 页面加载完成后的处理
document.addEventListener('DOMContentLoaded', function() {
  // 为语言卡片添加键盘导航
  const languageItems = document.querySelectorAll('.language-item');
  languageItems.forEach((item, index) => {
    item.setAttribute('tabindex', '0');
    item.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        // 可以添加展开/折叠功能
      }
    });
  });
});
</script>

{% endblock %}
