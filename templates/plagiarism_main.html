{% set page_name = "抄袭检测" %}
{% extends "layout/basic.html" %}
{% import "components/contest.html" as contest with context %}
{% import "components/form.html" as form with context %}

{% block content %}
<div class="row">
  <div class="medium-9 columns">
    <div class="section">
      <div class="section__header">
        <h1 class="section__title">
          {{ _('Plagiarism Detection') }} - {{ tdoc.title }}
        </h1>
      </div>
      <div class="section__body">
        <div class="typo">
          <p>{{ _('Use advanced plagiarism detection to analyze code similarities in contest submissions.') }}</p>
          {% if error %}
            <blockquote class="warn">
              <p><strong>{{ _('API Connection Error') }}:</strong> {{ error }}</p>
              <p>{{ _('Please ensure the Phosphorus backend is running at') }}: <code>{{ apiBase }}</code></p>
            </blockquote>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- 启动检测区域 -->
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">{{ _('Start New Detection') }}</h2>
      </div>
      <div class="section__body">
        <form id="plagiarism-form" method="post" action="{{ url('plagiarism_check', tid=tdoc._id) }}">
          <div class="row">
            <div class="medium-6 columns">
              <label>
                {{ _('Minimum Tokens') }}
                <input type="number" name="minTokens" value="9" min="1" max="100" class="textbox" required>
              </label>
              <div class="typo">
                <small>{{ _('Minimum number of tokens to consider for matching (1-100)') }}</small>
              </div>
            </div>
            <div class="medium-6 columns">
              <label>
                {{ _('Similarity Threshold') }}
                <input type="number" name="similarityThreshold" value="0.0" min="0" max="1" step="0.1" class="textbox">
              </label>
              <div class="typo">
                <small>{{ _('Minimum similarity threshold (0.0-1.0)') }}</small>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="medium-12 columns">
              <input type="hidden" name="csrfToken" value="{{ handler.csrfToken }}">
              <button type="submit" class="rounded primary button" id="check-btn">
                <span class="icon icon-search"></span>
                {{ _('Start Plagiarism Check') }}
              </button>
              <div id="loading" style="display: none; margin-top: 10px;">
                <div class="typo">
                  <p><span class="icon icon-loading"></span> {{ _('Analyzing submissions... This may take several minutes.') }}</p>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- 历史检测结果 -->
    {% if results %}
    <div class="section">
      <div class="section__header">
        <h2 class="section__title">{{ _('Detection History') }}</h2>
      </div>
      <div class="section__body no-padding">
        <table class="data-table">
          <colgroup>
            <col class="col--time">
            <col class="col--stats">
            <col class="col--similarity">
            <col class="col--operation">
          </colgroup>
          <thead>
            <tr>
              <th class="col--time">{{ _('Detection Time') }}</th>
              <th class="col--stats">{{ _('Statistics') }}</th>
              <th class="col--similarity">{{ _('High Similarity Pairs') }}</th>
              <th class="col--operation">{{ _('Operations') }}</th>
            </tr>
          </thead>
          <tbody>
            {% for result in results %}
            <tr>
              <td class="col--time">
                <time class="time">{{ result.created_at[:19] }}</time>
                <div class="typo">
                  <small>{{ _('Execution Time') }}: {{ result.execution_time_ms }}ms</small>
                </div>
              </td>
              <td class="col--stats">
                <div class="typo">
                  <p><strong>{{ result.total_submissions }}</strong> {{ _('submissions') }}</p>
                  <p><strong>{{ result.total_comparisons }}</strong> {{ _('comparisons') }}</p>
                  {% if result.failed_submissions %}
                    <p class="text-error"><strong>{{ result.failed_submissions|length }}</strong> {{ _('failed') }}</p>
                  {% endif %}
                </div>
              </td>
              <td class="col--similarity">
                {% if result.high_similarity_pairs %}
                  <span class="bp5-tag bp5-large bp5-intent-warning">
                    {{ result.high_similarity_pairs|length }} {{ _('pairs found') }}
                  </span>
                  <div class="typo">
                    <small>
                      {% if result.high_similarity_pairs %}
                        {{ _('Max similarity') }}: 
                        {{ (result.high_similarity_pairs|map(attribute='similarity')|max * 100)|round(1) }}%
                      {% endif %}
                    </small>
                  </div>
                {% else %}
                  <span class="bp5-tag bp5-large bp5-intent-success">{{ _('No high similarity') }}</span>
                {% endif %}
              </td>
              <td class="col--operation">
                <a href="{{ url('plagiarism_detail', tid=tdoc._id, rid=result._id) }}" 
                   class="rounded button">
                  <span class="icon icon-eye"></span>
                  {{ _('View Details') }}
                </a>
                <a href="{{ url('plagiarism_export', tid=tdoc._id, rid=result._id) }}" 
                   class="rounded button" download>
                  <span class="icon icon-download"></span>
                  {{ _('Export') }}
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% else %}
    <div class="section">
      <div class="section__body">
        <div class="typo">
          <blockquote class="note">
            <p>{{ _('No plagiarism detection results found for this contest.') }}</p>
          </blockquote>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="medium-3 columns">
    <div class="section">
      <div class="section__header">
        <h3 class="section__title">{{ _('Contest Info') }}</h3>
      </div>
      <div class="section__body">
        <div class="typo">
          <p><strong>{{ _('Contest ID') }}:</strong> {{ tdoc._id }}</p>
          <p><strong>{{ _('Problems') }}:</strong> {{ tdoc.pids|length }}</p>
          <p><strong>{{ _('Participants') }}:</strong> {{ tdoc.attend|default(0) }}</p>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section__header">
        <h3 class="section__title">{{ _('How it Works') }}</h3>
      </div>
      <div class="section__body">
        <div class="typo">
          <ol>
            <li>{{ _('Collects all accepted submissions') }}</li>
            <li>{{ _('Groups by problem and language') }}</li>
            <li>{{ _('Uses JPlag for similarity analysis') }}</li>
            <li>{{ _('Reports suspicious pairs and clusters') }}</li>
          </ol>
          <p><small>{{ _('Detection is performed by the Phosphorus backend service.') }}</small></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// AJAX 提交表单
document.getElementById('plagiarism-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const checkBtn = document.getElementById('check-btn');
    const loading = document.getElementById('loading');
    
    // 显示加载状态
    checkBtn.disabled = true;
    loading.style.display = 'block';
    
    try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // 成功，刷新页面显示新结果
            window.location.reload();
        } else {
            // 显示错误信息
            alert('Error: ' + (result.error || 'Unknown error occurred'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // 恢复按钮状态
        checkBtn.disabled = false;
        loading.style.display = 'none';
    }
});
</script>
{% endblock %}
